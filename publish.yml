name: publish

on:
  workflow_call:
    inputs:
      DO_ACCESS_TOKEN:
        required: true
      DO_REGISTRY:
        required: true
      ENV:
        required: true
      GCP_SQL_CREDENTIAL:
        required: true
      KUBE_CONFIG:
        required: true
      KUBE_CLUSTER_ID:
        required: true
      REPO_NAME:
        required: true
      SERVICE_SECRET:
        required: true

jobs:
  push-to-registry:
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ needs.build.result == 'success' }}
    timeout-minutes: 5
    steps:
      - uses: pnpm/action-setup@v3
        with:
          version: 8
      - uses: actions/checkout@v4
      - name: Install Doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ env.DO_ACCESS_TOKEN }}
      - name: Set Version ENV
        run: |
          export VERSION=$(grep version package.json | awk -F \" '{print $4}')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Login To Doctl Registry
        run: doctl registry login
      - name: Build Docker Image
        run: docker build --target production --tag ${{ env.DO_REGISTRY }}/${{ env.REPO_NAME }}-${{ env.ENV }}:${{ env.VERSION }} .
      - name: Push To Docker Registry
        run: docker push ${{ env.DO_REGISTRY }}/${{ env.REPO_NAME }}-${{ env.ENV }}:${{ env.VERSION }}
  deploy:
    cancel-timeout-minutes: 5
    runs-on: ubuntu-latest
    needs: [push-to-registry]
    if: ${{ needs.push-to-registry.result == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_ACCESS_TOKEN }}
      - name: Save DigitalOcean Kubeconfig
        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 1200 ${{ env.KUBE_CLUSTER_ID }}
      - name: Create Microservice Namespace
        run:
          kubectl create namespace ${{ env.ENV }} --dry-run=client -o yaml | kubectl apply -f -\

      - name: Create Secret YAML file
        run: |
          cat <<EOF > secret.yaml
          ${{ env.SERVICE_SECRET }}
      - name: Apply Secret
        run: kubectl apply -f secret.yaml
        
      - uses: akiojin/decode-base64-github-action@v0.1.0
        id: decode-gcp-credential
        with:
          base64: ${{ env.GCP_SQL_CREDENTIAL }}
      - name: Create CloudSQL Service Account JSON
        run: |
          cat <<EOF > service-account-key.json
          ${{ steps.decode-gcp-credential.outputs.decoded }}
          EOF
      - name: Create CloudSQL Secret
        run: |
          kubectl create secret generic cloudsql-instance-credentials \
          --from-file=credentials.json=./service-account-key.json \
          -n development \
          --dry-run=client -o yaml | kubectl apply -f -
      - name: Helm Deploy
        uses: vimeda/helm@v1.7.0
        with:
          release: ${{ env.REPO_NAME }}
          track: ${{ env.ENV }}
          version: ${{ env.VERSION }}
          namespace: ${{ env.ENV }}
          chart: '.helm-${{ env.ENV }}'
          token: ${{ github.token }}
        env:
          KUBECONFIG_FILE: '${{ env.KUBE_CONFIG }}'